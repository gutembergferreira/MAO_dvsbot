{% extends 'base.html' %}

{% block title %}Administrate Messages{% endblock %}
{% block titlepage %}Administrate Messages{% endblock %}
{% block head %}
<style>
.emoji-picker {
    position: absolute;
    background-color: #fff;
    border: 1px solid #ccc;
    padding: 10px;
    display: none;
    z-index: 1000;
    width: 300px; /* Define uma largura fixa */
}

.emoji-picker-container {
    position: relative;
}

.emoji-picker .emoji-category-nav {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}

.emoji-category {
    display: none;
    flex-wrap: wrap;
}

.emoji-category.active {
    display: flex;
}

.emoji-category span {
    cursor: pointer;
    font-size: 1.5em;
    margin: 5px;
}

.emoji-picker .emoji-category-nav button {
    flex: 1;
    margin-right: 2px;
}

.emoji-picker .emoji-category-nav button:last-child {
    margin-right: 0;
}

.select__box {
    display: flex;
    justify-content: flex-start;
    flex-direction: column;
    position: relative;
    overflow: hidden;
    background-color: #fafafa;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 10px;
}

.select__placeholder {
    position: absolute;
    top: 0;
    left: 10px;
    padding: 5px 10px;
    color: #888;
    pointer-events: none; /* Impede que o placeholder interfira com a sele√ß√£o */
}

.select__box:hover {
    height: auto;
}

.select__box:hover .select__field::after {
    transform: rotate(135deg);
}

.select__box #option-01:checked ~ .select__field .option-01 {
    display: inline;
}

.select__box #option-02:checked ~ .select__field .option-02 {
    display: inline;
}

.select__box #option-03:checked ~ .select__field .option-03 {
    display: inline;
}

.select__box #option-04:checked ~ .select__field .option-04 {
    display: inline;
}

.select__box #option-05:checked ~ .select__field .option-05 {
    display: inline;
}

.select__field {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    position: absolute;
    top: 0;
    width: 100%;
    height: 2rem;
    padding: 0.35rem;
    border: 1px solid #ddd;
    background-color: #fff;
}

.select__field::after {
    content: '';
    display: block;
    position: absolute;
    right: 0.5rem;
    bottom: 0.6rem;
    width: 0.5rem;
    height: 0.5rem;
    border: 0 solid #ccc;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}

.select__option {
    display: none;
    margin-right: 0.4rem;
    padding: 0.1em 0.4em;
    font-size: 0.9em;
    line-height: 1;
    color: #fff;
    border-radius: 3px;
    background-color: hsl(190, 60%, 60%);
}

.select__flag {
    display: none;
}

.select__flag:checked + *::after {
    content: '';
    display: block;
    position: absolute;
    right: 0.5rem;
    bottom: 0.6rem;
    width: 0.5rem;
    height: 0.7em;
    border: 0 solid hsl(170, 60%, 60%);
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}

.select__flag:checked + .select__trigger {
    background-color: #007bff;
    color: white;
}

.select__trigger {
    display: block;
    position: relative;
    width: 100%;
    background-color: #f0f0f0;
    border-radius: 5px;
    padding: 5px 10px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.05rem;
    color: #555;
    border: 0 solid #ddd;
    border-width: 0 1px 1px 1px;
}

.select__trigger:first-of-type {
    margin-top: 2rem;
}
</style>
{% endblock %}

{% block content %}
<div class="accordion" id="accordionExample">
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                Add New Message
            </button>
        </h2>
        <div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
            <div class="accordion-body">
                <form method="POST" action="{{ url_for('schedule_message_route') }}">
                    <div class="row">
                        <!-- Primeira Coluna -->
                        <div class="col-md-6">
                            <!-- Sele√ß√£o do Bot -->
                            <div class="mb-3">
                                <label for="webhook_id" class="form-label">Bot:</label>
                                <select name="webhook_id" id="webhook_id" class="form-select" aria-label="Select Bot" required>
                                    <option value="">Select Bot</option>
                                    {% for webhook in webhooks %}
                                    <option value="{{ webhook.id }}">{{ webhook.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                
                            <!-- Sele√ß√£o do Hor√°rio -->
                            <div class="mb-3">
                                <label for="send_time" class="form-label">Send Time:</label>
                                <input type="time" id="send_time" name="send_time" class="form-control" required>
                            </div>
                
                            <!-- Sele√ß√£o dos Dias da Semana -->
                            <div class="mb-3">
                                <label for="days_of_week" class="form-label">Days of Week:</label>
                                <div class='select__box'>
                                    <span class='select__placeholder'>Select days...</span>
                                    
                                    <input class='select__flag' id='option-01' type='checkbox' name="days_of_week" value="monday">
                                    <label class='select__trigger' for='option-01'>Monday</label>
                                
                                    <input class='select__flag' id='option-02' type='checkbox' name="days_of_week" value="tuesday">
                                    <label class='select__trigger' for='option-02'>Tuesday</label>
                                
                                    <input class='select__flag' id='option-03' type='checkbox' name="days_of_week" value="wednesday">
                                    <label class='select__trigger' for='option-03'>Wednesday</label>
                                
                                    <input class='select__flag' id='option-04' type='checkbox' name="days_of_week" value="thursday">
                                    <label class='select__trigger' for='option-04'>Thursday</label>
                                
                                    <input class='select__flag' id='option-05' type='checkbox' name="days_of_week" value="friday">
                                    <label class='select__trigger' for='option-05'>Friday</label>
                
                                    <div class='select__field'>
                                        <span class='select__option option-01'>Monday</span>
                                        <span class='select__option option-02'>Tuesday</span>
                                        <span class='select__option option-03'>Wednesday</span>
                                        <span class='select__option option-04'>Thursday</span>
                                        <span class='select__option option-05'>Friday</span>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end">
                                <label for="active" class="form-label me-2">Task is active?</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" name="active" id="active" checked>
                                    <label class="form-check-label" for="active">off/on</label>
                                </div>
                            </div>
                        </div>
                
                        <!-- Segunda Coluna -->
                        <div class="col-md-6 d-flex flex-column">
                            <div class="mb-3 flex-grow-1">
                                <label for="message" class="form-label">Message:</label>
                    
                                <!-- Bot√£o para abrir a caixa de emojis -->
                                <div class="emoji-picker-container">
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="wrapText('message', '*', '*')">Negrito</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="wrapText('message', '_', '_')">It√°lico</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleEmojiPicker()">üòä Emojis</button>
                                    <div id="emoji-picker" class="emoji-picker">
                                        <div class="emoji-category-nav">
                                            <button type="button" class="btn btn-sm" onclick="showCategory('smileys')">üòÄ</button>
                                            <button type="button" class="btn btn-sm" onclick="showCategory('gestures')">üëç</button>
                                            <button type="button" class="btn btn-sm" onclick="showCategory('objects')">üéâ</button>
                                            <button type="button" class="btn btn-sm" onclick="showCategory('nature')">üåç</button>
                                            <button type="button" class="btn btn-sm" onclick="showCategory('travel')">‚úàÔ∏è</button>
                                        </div>
                                        <div id="smileys" class="emoji-category active">
                                            <span onclick="insertEmoji('üòä')">üòä</span>
                                            <span onclick="insertEmoji('üòÇ')">üòÇ</span>
                                            <span onclick="insertEmoji('üòç')">üòç</span>
                                            <span onclick="insertEmoji('üò¢')">üò¢</span>
                                            <span onclick="insertEmoji('üòé')">üòé</span>
                                            <span onclick="insertEmoji('üò°')">üò°</span>
                                            <span onclick="insertEmoji('üò±')">üò±</span>
                                            <span onclick="insertEmoji('üò¥')">üò¥</span>
                                            <span onclick="insertEmoji('üòá')">üòá</span>
                                            <span onclick="insertEmoji('üòò')">üòò</span>
                                            <span onclick="insertEmoji('üò≠')">üò≠</span>
                                            <span onclick="insertEmoji('ü§î')">ü§î</span>
                                            <span onclick="insertEmoji('ü§ó')">ü§ó</span>
                                            <span onclick="insertEmoji('ü§©')">ü§©</span>
                                            <span onclick="insertEmoji('üòú')">üòú</span>
                                            <span onclick="insertEmoji('ü§®')">ü§®</span>
                                        </div>
                                        <div id="gestures" class="emoji-category">
                                            <span onclick="insertEmoji('üëç')">üëç</span>
                                            <span onclick="insertEmoji('üëé')">üëé</span>
                                            <span onclick="insertEmoji('üëè')">üëè</span>
                                            <span onclick="insertEmoji('üôè')">üôè</span>
                                            <span onclick="insertEmoji('‚úåÔ∏è')">‚úåÔ∏è</span>
                                            <span onclick="insertEmoji('üëå')">üëå</span>
                                            <span onclick="insertEmoji('üëä')">üëä</span>
                                            <span onclick="insertEmoji('ü§ù')">ü§ù</span>
                                            <span onclick="insertEmoji('üôå')">üôå</span>
                                            <span onclick="insertEmoji('ü§ò')">ü§ò</span>
                                            <span onclick="insertEmoji('üëã')">üëã</span>
                                        </div>
                                        <div id="objects" class="emoji-category">
                                            <span onclick="insertEmoji('üéâ')">üéâ</span>
                                            <span onclick="insertEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
                                            <span onclick="insertEmoji('üí°')">üí°</span>
                                            <span onclick="insertEmoji('üìÖ')">üìÖ</span>
                                            <span onclick="insertEmoji('üìû')">üìû</span>
                                            <span onclick="insertEmoji('üíª')">üíª</span>
                                            <span onclick="insertEmoji('‚úâÔ∏è')">‚úâÔ∏è</span>
                                            <span onclick="insertEmoji('üìé')">üìé</span>
                                            <span onclick="insertEmoji('üñäÔ∏è')">üñäÔ∏è</span>
                                            <span onclick="insertEmoji('üìö')">üìö</span>
                                        </div>
                                        <div id="nature" class="emoji-category">
                                            <span onclick="insertEmoji('üåû')">üåû</span>
                                            <span onclick="insertEmoji('üåú')">üåú</span>
                                            <span onclick="insertEmoji('üåü')">üåü</span>
                                            <span onclick="insertEmoji('üî•')">üî•</span>
                                            <span onclick="insertEmoji('üíß')">üíß</span>
                                            <span onclick="insertEmoji('üåà')">üåà</span>
                                            <span onclick="insertEmoji('üåç')">üåç</span>
                                            <span onclick="insertEmoji('üê∂')">üê∂</span>
                                            <span onclick="insertEmoji('üê±')">üê±</span>
                                            <span onclick="insertEmoji('üê≠')">üê≠</span>
                                            <span onclick="insertEmoji('üêº')">üêº</span>
                                            <span onclick="insertEmoji('ü¶Ñ')">ü¶Ñ</span>
                                        </div>
                                        <div id="travel" class="emoji-category">
                                            <span onclick="insertEmoji('üöó')">üöó</span>
                                            <span onclick="insertEmoji('‚úàÔ∏è')">‚úàÔ∏è</span>
                                            <span onclick="insertEmoji('üöÄ')">üöÄ</span>
                                            <span onclick="insertEmoji('üöÅ')">üöÅ</span>
                                            <span onclick="insertEmoji('üè†')">üè†</span>
                                            <span onclick="insertEmoji('üè¢')">üè¢</span>
                                            <span onclick="insertEmoji('üèñÔ∏è')">üèñÔ∏è</span>
                                            <span onclick="insertEmoji('üåã')">üåã</span>
                                        </div>
                                    </div>
                                </div>
                                <br>
                                <textarea id="message" name="message" class="form-control" aria-label="With textarea" required style="height: 81%;" placeholder="."></textarea>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary">Schedule Message</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<hr class="my-3">
<br>
<h2>Messages Schedule:</h2>
<table
data-toggle="table"
data-search="true"
data-show-columns="true"
data-minimum-count-columns="2"
data-show-pagination-switch="true"
data-pagination="true"
data-id-field="id"
data-page-list="[10, 25, 50, 100, all]"
>
<thead class="table-dark text-center">
    <th data-width="10" data-field="id" data-valign="middle">ID</th>
    <th data-width="10" data-field="active" data-custom-attribute="actived">Actived</th>
    <th data-width="10" data-field="webhook">Bot</th>
    <th data-width="700" data-field="message">Message</th>
    <th data-width="10" data-field="hour" data-custom-attribute="hour">Hour</th>
    <th data-width="20" data-field="days" data-custom-attribute="days">Days of Week</th>
    <th data-width="10" data-field="add">Edit</th>
    <th data-width="10" data-field="delete">Delete</th>
</thead>
<tbody>
  {% for message in messages %}
  <tr id="tr-id-{{ message.id }}" class="tr-class-{{ loop.index }}">
    <td class="text-center">{{ message.id }}</td>
    <td class="text-center">
      {% if message.active == True %}
        <i class="material-icons" style="color: green; font-size: 25px;">task_alt</i>
      {% else %}
        <i class="material-icons" style="color: red; font-size: 25px;">block</i>
      {% endif %}
    </td>
    <td class="text-center">{{ message.webhook.name }}</td>
    <td>{{ message.message }}</td>
    <td class="text-center">{{ message.send_time }}</td>
    <td>{{ message.days_of_week }}</td>
    <td class="text-center">
      <a href="{{ url_for('edit_message', message_id=message.id) }}" style="text-decoration:none;">
          <button type="button" style="background: none; border: none; padding: 0; margin: 0; cursor: pointer;">
              <i class="material-icons" style="color: green; font-size: 25px;">edit</i>
          </button>
      </a>
    </td>
    <td>
      <form method="POST" action="{{ url_for('delete_message', message_id=message.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this message?');">
        <button type="submit" style="background: none; border: none; padding: 0; margin: 0; cursor: pointer;">
            <i class="material-icons" style="color: red; font-size: 25px;">delete_forever</i>
        </button>
    </form>
    </td>

  </tr>
  {% endfor %}
</tbody>
</table>

<script>
function wrapText(textareaId, prefix, suffix) {
    const textarea = document.getElementById(textareaId);
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    const selectedText = text.substring(start, end);

    textarea.value = text.slice(0, start) + prefix + selectedText + suffix + text.slice(end);
    textarea.focus();
    textarea.setSelectionRange(start + prefix.length, end + prefix.length);
}

function toggleEmojiPicker() {
    const picker = document.getElementById('emoji-picker');
    picker.style.display = picker.style.display === 'none' || picker.style.display === '' ? 'block' : 'none';
}

function showCategory(category) {
    const categories = document.querySelectorAll('.emoji-category');
    categories.forEach(cat => {
        cat.classList.remove('active');
        if (cat.id === category) {
            cat.classList.add('active');
        }
    });
}

function insertEmoji(emoji) {
    const textarea = document.getElementById('message');
    textarea.value += emoji;
    toggleEmojiPicker();  // Fecha o emoji picker ap√≥s a sele√ß√£o
}

// Oculta o emoji picker se o usu√°rio clicar fora dele
document.addEventListener('click', function(event) {
    const picker = document.getElementById('emoji-picker');
    const button = event.target.closest('button');
    if (!picker.contains(event.target) && (!button || !button.classList.contains('btn-outline-secondary'))) {
        picker.style.display = 'none';
    }
});
</script>
{% endblock %}

{% block javascript %}]
<script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@latest/dist/emoji-button.min.js"></script>
{% endblock %}